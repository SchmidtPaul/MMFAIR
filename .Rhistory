labels = labs %>% pull(varStructB) %>% round(2),
sec.axis = sec_axis(~ .,
name = "VarStructA",
breaks = labs %>% pull(X),
labels = labs %>% pull(varStructA) %>% round(2))) +
theme(legend.text.align = 1,
axis.text.x = element_text(angle=90, hjust=1))
MAT
labs <- MAT %>% dplyr::select(X, date_densf, varStructA, varStructB) %>% unique
ggplot(data=MAT, aes(x=X, y=Y)) + coord_fixed() +
geom_tile(aes( fill=Variance), color="grey") +
geom_label(aes(x=1, y=15,
label=paste0("sigma = ", sigma %>% unique %>% round(2))),
color="black", hjust=-0.1, vjust=0.5) +
scale_fill_viridis(option="D", na.value="white",
guide  ="legend", name=NULL,
breaks = MAT %>% pull(Variance) %>% unique %>% sort,
labels = scales::number_format(accuracy = 0.01)) +
scale_y_continuous(name = "VarStructA",
trans = "reverse",
expand = c(0,0),
breaks = labs %>% pull(X),
labels = labs %>% pull(date_densf)) +
scale_x_continuous(name = "VarStructB",
expand = c(0,0),
breaks = labs %>% pull(X),
labels = labs %>% pull(varStructB) %>% round(2),
sec.axis = sec_axis(~ .,
name = "VarStructA",
breaks = labs %>% pull(X),
labels = labs %>% pull(varStructA) %>% round(2))) +
theme(legend.text.align = 1,
axis.text.x = element_text(angle=90, hjust=1))
MAT
pacman::p_load(dplyr, purrr, tibble, tidyr, # data handling
ggplot2, viridis,            # plot
nlme, lme4, glmmTMB, sommer, # mixed modelling
AICcmodavg, broom.mixed)     # mixed model extractions
{
dat <- agridat::mcconway.turnip %>%
as_tibble() %>%
mutate(densf = density %>% as.factor) %>%
mutate(date_densf = interaction(date, densf)) # needed for mod5
mod1.nlme <- nlme::lme(fixed   = yield ~ gen * date * densf,
random  = ~ 1|block,
weights = NULL, # default, i.e. homoscedastic errors
data    = dat)
mod2.nlme <- mod1.nlme %>%
update(weights = varIdent(form=~1|date))
mod3.nlme <- mod1.nlme %>%
update(weights = varIdent(form=~1|densf))
mod4.nlme <- mod1.nlme %>%
update(weights = varComb(varIdent(form=~1|date),
varIdent(form=~1|densf)))
mod5.nlme <- mod1.nlme %>%
update(weights = varIdent(form=~1|date_densf))
mod1.nlme.VC <- tibble(grp="homoscedastic", varStruct=1) %>%
mutate(sigma         = mod1.nlme$sigma) %>%
mutate(StandardError = sigma*varStruct) %>%
mutate(Variance      = StandardError^2)
mod2.nlme.VC <- mod2.nlme$modelStruct$varStruct %>%
coef(unconstrained=FALSE, allCoef=TRUE) %>%
enframe(name="grp", value="varStruct") %>%
mutate(sigma         = mod2.nlme$sigma) %>%
mutate(StandardError = sigma*varStruct) %>%
mutate(Variance      = StandardError^2)
mod3.nlme.VC <- mod3.nlme$modelStruct$varStruct %>%
coef(unconstrained=FALSE, allCoef=TRUE) %>%
enframe(name="grp", value="varStruct") %>%
mutate(sigma         = mod3.nlme$sigma) %>%
mutate(StandardError = sigma*varStruct) %>%
mutate(Variance      = StandardError^2)
mod4.nlme.varStruct.A <- mod4.nlme$modelStruct$varStruct$A %>%
coef(unconstrained=FALSE, allCoef=TRUE) %>%
enframe(name="grpA", value="varStructA")
mod4.nlme.varStruct.B <- mod4.nlme$modelStruct$varStruct$B %>%
coef(unconstrained=FALSE, allCoef=TRUE) %>%
enframe(name="grpB", value="varStructB")
mod4.nlme.VC <- expand.grid(mod4.nlme.varStruct.A$grpA,
mod4.nlme.varStruct.B$grpB,
stringsAsFactors=FALSE) %>%
rename(grpA=Var1, grpB=Var2) %>%
left_join(x=., y=mod4.nlme.varStruct.A, by="grpA") %>%
left_join(x=., y=mod4.nlme.varStruct.B, by="grpB") %>%
mutate(sigma         = mod4.nlme$sigma) %>%
mutate(StandardError = sigma*varStructA*varStructB) %>%
mutate(Variance      = StandardError^2)
mod5.nlme.VC <- mod5.nlme$modelStruct$varStruct %>%
coef(unconstrained=FALSE, allCoef=TRUE) %>%
enframe(name="grp", value="varStruct") %>%
separate(grp, sep="[.]", into=c("grpA","grpB")) %>%
mutate(sigma         = mod5.nlme$sigma) %>%
mutate(StandardError = sigma*varStruct) %>%
mutate(Variance      = StandardError^2)
} # get nlme VC from het diag example
setup <- dat %>%
filter(block=="B1") %>%
arrange(date, density) %>%
dplyr::select(-yield) %>%
mutate(label=paste0(date_densf,".",block),
nID=1:n())
mat1 <- left_join(x  = setup %>% mutate(grp="homoscedastic"),
y  = mod1.nlme.VC %>% dplyr::select(-StandardError) ,
by = c("grp"="grp")) %>%
left_join(x  = expand.grid(X=.$nID, Y=.$nID),
y  = .,
by = c("X"="nID")) %>% as_tibble() %>%
mutate(Variance = case_when(X==Y~Variance, TRUE~NA_real_))
mat2 <- left_join(x  = setup,
y  = mod2.nlme.VC %>% dplyr::select(-StandardError),
by = c("date"="grp")) %>%
left_join(x  = expand.grid(X=.$nID, Y=.$nID),
y  = .,
by = c("X"="nID")) %>% as_tibble() %>%
mutate(Variance = case_when(X==Y~Variance, TRUE~NA_real_))
mat3 <- left_join(x  = setup,
y  = mod3.nlme.VC %>% dplyr::select(-StandardError),
by = c("densf"="grp")) %>%
left_join(x  = expand.grid(X=.$nID, Y=.$nID),
y  = .,
by = c("X"="nID")) %>% as_tibble() %>%
mutate(Variance = case_when(X==Y~Variance, TRUE~NA_real_))
mat4 <- left_join(x  = setup,
y  = mod4.nlme.VC %>% dplyr::select(-StandardError),
by = c("date"="grpA", "densf"="grpB")) %>%
left_join(x  = expand.grid(X=.$nID, Y=.$nID),
y  = .,
by = c("X"="nID")) %>% as_tibble() %>%
mutate(Variance = case_when(X==Y~Variance, TRUE~NA_real_))
mat5 <- left_join(x  = setup,
y  = mod5.nlme.VC %>% dplyr::select(-StandardError),
by = c("date"="grpA", "densf"="grpB")) %>%
left_join(x  = expand.grid(X=.$nID, Y=.$nID),
y  = .,
by = c("X"="nID")) %>% as_tibble() %>%
mutate(Variance = case_when(X==Y~Variance, TRUE~NA_real_))
library(ggplot2)
MAT <- mat4
labs <- MAT %>%
mutate(ddlab = paste0("date: ",date," dens: ", density, " gen: ", gen))
labs
labs <- MAT %>%
mutate(ddlab = paste0("date: ",date," dens: ", density, " gen: ", gen)) %>%
dplyr::select(X, ddlab, varStructA, varStructB) %>% unique
labs
ggplot(data=MAT, aes(x=X, y=Y)) + coord_fixed() +
geom_tile(aes( fill=Variance), color="grey") +
geom_label(aes(x=1, y=15,
label=paste0("sigma = ", sigma %>% unique %>% round(2))),
color="black", hjust=-0.1, vjust=0.5) +
scale_fill_viridis(option="D", na.value="white",
guide  ="legend", name=NULL,
breaks = MAT %>% pull(Variance) %>% unique %>% sort,
labels = scales::number_format(accuracy = 0.01)) +
scale_y_continuous(name = "VarStructA",
trans = "reverse",
expand = c(0,0),
breaks = labs %>% pull(X),
labels = labs %>% pull(ddlab)) +
scale_x_continuous(name = "VarStructB",
expand = c(0,0),
breaks = labs %>% pull(X),
labels = labs %>% pull(varStructB) %>% round(2),
sec.axis = sec_axis(~ .,
name = "VarStructA",
breaks = labs %>% pull(X),
labels = labs %>% pull(varStructA) %>% round(2))) +
theme(legend.text.align = 1,
axis.text.x = element_text(angle=90, hjust=1))
ggplot(data=MAT, aes(x=X, y=Y)) + coord_fixed() +
geom_tile(aes( fill=Variance), color="grey") +
geom_label(aes(x=1, y=15,
label=paste0("sigma = ", sigma %>% unique %>% round(2))),
color="black", hjust=-0.1, vjust=0.5) +
scale_fill_viridis(option="D", na.value="white",
guide  ="legend", name=NULL,
breaks = MAT %>% pull(Variance) %>% unique %>% sort,
labels = scales::number_format(accuracy = 0.01)) +
scale_y_continuous(name = "VarStructA",
trans = "reverse",
expand = c(0,0),
breaks = labs %>% pull(X),
labels = labs %>% pull(date_densf)) +
scale_x_continuous(name = "VarStructB",
expand = c(0,0),
breaks = labs %>% pull(X),
labels = labs %>% pull(varStructB) %>% round(2),
sec.axis = sec_axis(~ .,
name = "VarStructA",
breaks = labs %>% pull(X),
labels = labs %>% pull(varStructA) %>% round(2))) +
theme(legend.text.align = 1,
axis.text.x = element_text(angle=90, hjust=1))
MAT
labs <- MAT %>%
# mutate(ddlab = paste0("date: ",date," dens: ", density, " gen: ", gen)) %>%
dplyr::select(X, date_densf , varStructA, varStructB) %>% unique
ggplot(data=MAT, aes(x=X, y=Y)) + coord_fixed() +
geom_tile(aes( fill=Variance), color="grey") +
geom_label(aes(x=1, y=15,
label=paste0("sigma = ", sigma %>% unique %>% round(2))),
color="black", hjust=-0.1, vjust=0.5) +
scale_fill_viridis(option="D", na.value="white",
guide  ="legend", name=NULL,
breaks = MAT %>% pull(Variance) %>% unique %>% sort,
labels = scales::number_format(accuracy = 0.01)) +
scale_y_continuous(name = "VarStructA",
trans = "reverse",
expand = c(0,0),
breaks = labs %>% pull(X),
labels = labs %>% pull(date_densf)) +
scale_x_continuous(name = "VarStructB",
expand = c(0,0),
breaks = labs %>% pull(X),
labels = labs %>% pull(varStructB) %>% round(2),
sec.axis = sec_axis(~ .,
name = "VarStructA",
breaks = labs %>% pull(X),
labels = labs %>% pull(varStructA) %>% round(2))) +
theme(legend.text.align = 1,
axis.text.x = element_text(angle=90, hjust=1))
labs <- MAT %>%
# mutate(ddlab = paste0("date: ",date," dens: ", density, " gen: ", gen)) %>%
dplyr::select(X, date_densf, gen, varStructA, varStructB) %>% unique
labels = labs %>% pull(gen)) +
ggplot(data=MAT, aes(x=X, y=Y)) + coord_fixed() +
geom_tile(aes( fill=Variance), color="grey") +
geom_label(aes(x=1, y=15,
label=paste0("sigma = ", sigma %>% unique %>% round(2))),
color="black", hjust=-0.1, vjust=0.5) +
scale_fill_viridis(option="D", na.value="white",
guide  ="legend", name=NULL,
breaks = MAT %>% pull(Variance) %>% unique %>% sort,
labels = scales::number_format(accuracy = 0.01)) +
scale_y_continuous(name = "date_densf",
trans = "reverse",
expand = c(0,0),
breaks = labs %>% pull(X),
labels = labs %>% pull(date_densf),
sec.axis = sec_axis(~ .,
trans = "reverse",
breaks = labs %>% pull(X),
labels = labs %>% pull(gen))) +
scale_x_continuous(name = "VarStructB",
expand = c(0,0),
breaks = labs %>% pull(X),
labels = labs %>% pull(varStructB) %>% round(2),
sec.axis = sec_axis(~ .,
name = "VarStructA",
breaks = labs %>% pull(X),
labels = labs %>% pull(varStructA) %>% round(2))) +
theme(legend.text.align = 1,
axis.text.x = element_text(angle=90, hjust=1))
ggplot(data=MAT, aes(x=X, y=Y)) + coord_fixed() +
geom_tile(aes( fill=Variance), color="grey") +
geom_label(aes(x=1, y=15,
label=paste0("sigma = ", sigma %>% unique %>% round(2))),
color="black", hjust=-0.1, vjust=0.5) +
scale_fill_viridis(option="D", na.value="white",
guide  ="legend", name=NULL,
breaks = MAT %>% pull(Variance) %>% unique %>% sort,
labels = scales::number_format(accuracy = 0.01)) +
scale_y_continuous(name = "date_densf",
trans = "reverse",
expand = c(0,0),
breaks = labs %>% pull(X),
labels = labs %>% pull(date_densf),
sec.axis = sec_axis(~ .,
breaks = labs %>% pull(X),
labels = labs %>% pull(gen))) +
scale_x_continuous(name = "VarStructB",
expand = c(0,0),
breaks = labs %>% pull(X),
labels = labs %>% pull(varStructB) %>% round(2),
sec.axis = sec_axis(~ .,
name = "VarStructA",
breaks = labs %>% pull(X),
labels = labs %>% pull(varStructA) %>% round(2))) +
theme(legend.text.align = 1,
axis.text.x = element_text(angle=90, hjust=1))
ggplot(data=MAT, aes(x=X, y=Y)) + coord_fixed() +
geom_tile(aes( fill=Variance), color="grey") +
geom_label(aes(x=1, y=15,
label=paste0("sigma = ", sigma %>% unique %>% round(2))),
color="black", hjust=-0.1, vjust=0.5) +
scale_fill_viridis(option="D", na.value="white",
guide  ="legend", name=NULL,
breaks = MAT %>% pull(Variance) %>% unique %>% sort,
labels = scales::number_format(accuracy = 0.01)) +
scale_y_continuous(name = "date_densf",
trans = "reverse",
expand = c(0,0),
breaks = labs %>% pull(X),
labels = labs %>% pull(date_densf),
sec.axis = sec_axis(~ .,
name = "gen"
breaks = labs %>% pull(X),
labels = labs %>% pull(gen))) +
scale_x_continuous(name = "VarStructB",
expand = c(0,0),
breaks = labs %>% pull(X),
labels = labs %>% pull(varStructB) %>% round(2),
sec.axis = sec_axis(~ .,
name = "VarStructA",
breaks = labs %>% pull(X),
labels = labs %>% pull(varStructA) %>% round(2))) +
theme(legend.text.align = 1,
axis.text.x = element_text(angle=90, hjust=1))
ggplot(data=MAT, aes(x=X, y=Y)) + coord_fixed() +
geom_tile(aes( fill=Variance), color="grey") +
geom_label(aes(x=1, y=15,
label=paste0("sigma = ", sigma %>% unique %>% round(2))),
color="black", hjust=-0.1, vjust=0.5) +
scale_fill_viridis(option="D", na.value="white",
guide  ="legend", name=NULL,
breaks = MAT %>% pull(Variance) %>% unique %>% sort,
labels = scales::number_format(accuracy = 0.01)) +
scale_y_continuous(name = "date_densf",
trans = "reverse",
expand = c(0,0),
breaks = labs %>% pull(X),
labels = labs %>% pull(date_densf),
sec.axis = sec_axis(~ .,
name = "gen",
breaks = labs %>% pull(X),
labels = labs %>% pull(gen))) +
scale_x_continuous(name = "VarStructB",
expand = c(0,0),
breaks = labs %>% pull(X),
labels = labs %>% pull(varStructB) %>% round(2),
sec.axis = sec_axis(~ .,
name = "VarStructA",
breaks = labs %>% pull(X),
labels = labs %>% pull(varStructA) %>% round(2))) +
theme(legend.text.align = 1,
axis.text.x = element_text(angle=90, hjust=1))
ggplot(data=MAT, aes(x=X, y=Y)) + coord_fixed() +
geom_tile(aes( fill=Variance), color="grey") +
geom_label(aes(x=1, y=15,
label=paste0("sigma = ", sigma %>% unique %>% round(2))),
color="black", hjust=-0.1, vjust=0.5) +
scale_fill_viridis(option="D", na.value="white",
guide  ="legend", name=NULL,
breaks = MAT %>% pull(Variance) %>% unique %>% sort,
labels = scales::number_format(accuracy = 0.01)) +
scale_y_continuous(name = "date-density-combination",
trans = "reverse",
expand = c(0,0),
breaks = labs %>% pull(X),
labels = labs %>% pull(date_densf),
sec.axis = sec_axis(~ .,
name = "genotpye",
breaks = labs %>% pull(X),
labels = labs %>% pull(gen))) +
scale_x_continuous(name = "VarStructB",
expand = c(0,0),
breaks = labs %>% pull(X),
labels = labs %>% pull(varStructB) %>% round(2),
sec.axis = sec_axis(~ .,
name = "VarStructA",
breaks = labs %>% pull(X),
labels = labs %>% pull(varStructA) %>% round(2))) +
theme(legend.text.align = 1,
axis.text.x = element_text(angle=90, hjust=1))
ggplot(data=MAT, aes(x=X, y=Y)) + coord_fixed() +
geom_tile(aes( fill=Variance), color="grey") +
geom_label(aes(x=1, y=15,
label=paste0("sigma = ", sigma %>% unique %>% round(2))),
color="black", hjust=-0.1, vjust=0.5) +
scale_fill_viridis(option="D", na.value="white",
guide  ="legend", name="Variance",
breaks = MAT %>% pull(Variance) %>% unique %>% sort,
labels = scales::number_format(accuracy = 0.01)) +
scale_y_continuous(name = "date-density-combination",
trans = "reverse",
expand = c(0,0),
breaks = labs %>% pull(X),
labels = labs %>% pull(date_densf),
sec.axis = sec_axis(~ .,
name = "genotpye",
breaks = labs %>% pull(X),
labels = labs %>% pull(gen))) +
scale_x_continuous(name = "VarStructB",
expand = c(0,0),
breaks = labs %>% pull(X),
labels = labs %>% pull(varStructB) %>% round(2),
sec.axis = sec_axis(~ .,
name = "VarStructA",
breaks = labs %>% pull(X),
labels = labs %>% pull(varStructA) %>% round(2))) +
theme(legend.text.align = 1,
axis.text.x = element_text(angle=90, hjust=1))
ggplot(data=MAT, aes(x=X, y=Y)) + coord_fixed() +
geom_tile(aes( fill=Variance), color="grey") +
geom_label(aes(x=1, y=15,
label=paste0("sigma = ", sigma %>% unique %>% round(2))),
color="black", hjust=-0.1, vjust=0.5) +
scale_fill_viridis(option="D", na.value="white",
guide  ="legend", name="Variance\nestimate",
breaks = MAT %>% pull(Variance) %>% unique %>% sort,
labels = scales::number_format(accuracy = 0.01)) +
scale_y_continuous(name = "date-density-combination",
trans = "reverse",
expand = c(0,0),
breaks = labs %>% pull(X),
labels = labs %>% pull(date_densf),
sec.axis = sec_axis(~ .,
name = "genotpye",
breaks = labs %>% pull(X),
labels = labs %>% pull(gen))) +
scale_x_continuous(name = "VarStructB",
expand = c(0,0),
breaks = labs %>% pull(X),
labels = labs %>% pull(varStructB) %>% round(2),
sec.axis = sec_axis(~ .,
name = "VarStructA",
breaks = labs %>% pull(X),
labels = labs %>% pull(varStructA) %>% round(2))) +
theme(legend.text.align = 1,
axis.text.x = element_text(angle=90, hjust=1))
ggplot(data=MAT, aes(x=X, y=Y)) + coord_fixed() +
geom_tile(aes( fill=Variance), color="grey") +
geom_label(aes(x=1, y=15,
label=paste0("sigma = ", sigma %>% unique %>% round(2))),
color="black", hjust=-0.1, vjust=0.5) +
scale_fill_viridis(option="D", na.value="white",
guide  ="legend", name="Variance\nEstimate",
breaks = MAT %>% pull(Variance) %>% unique %>% sort,
labels = scales::number_format(accuracy = 0.01)) +
scale_y_continuous(name = "date-density-combination",
trans = "reverse",
expand = c(0,0),
breaks = labs %>% pull(X),
labels = labs %>% pull(date_densf),
sec.axis = sec_axis(~ .,
name = "genotpye",
breaks = labs %>% pull(X),
labels = labs %>% pull(gen))) +
scale_x_continuous(name = "VarStructB",
expand = c(0,0),
breaks = labs %>% pull(X),
labels = labs %>% pull(varStructB) %>% round(2),
sec.axis = sec_axis(~ .,
name = "VarStructA",
breaks = labs %>% pull(X),
labels = labs %>% pull(varStructA) %>% round(2))) +
theme(legend.text.align = 1,
axis.text.x = element_text(angle=90, hjust=1))
ggplot(data=MAT, aes(x=X, y=Y)) + coord_fixed() +
geom_tile(aes( fill=Variance), color="grey") +
# geom_label(aes(x=1, y=15,
#                label=paste0("sigma = ", sigma %>% unique %>% round(2))),
#            color="black", hjust=-0.1, vjust=0.5) +
scale_fill_viridis(option="D", na.value="white",
guide  ="legend", name="Variance\nEstimate",
breaks = MAT %>% pull(Variance) %>% unique %>% sort,
labels = scales::number_format(accuracy = 0.01)) +
scale_y_continuous(name = "date-density-combination",
trans = "reverse",
expand = c(0,0),
breaks = labs %>% pull(X),
labels = labs %>% pull(date_densf),
sec.axis = sec_axis(~ .,
name = "genotpye",
breaks = labs %>% pull(X),
labels = labs %>% pull(gen))) +
scale_x_continuous(name = "VarStructB",
expand = c(0,0),
breaks = labs %>% pull(X),
labels = labs %>% pull(varStructB) %>% round(2),
sec.axis = sec_axis(~ .,
name = "VarStructA",
breaks = labs %>% pull(X),
labels = labs %>% pull(varStructA) %>% round(2))) +
theme(legend.text.align = 1,
axis.text.x = element_text(angle=90, hjust=1))
MAT <- mat5
MAT
labs <- MAT %>%
dplyr::select(X, date_densf, gen, varStruct) %>% unique
labs
ggplot(data=MAT, aes(x=X, y=Y)) + coord_fixed() +
geom_tile(aes( fill=Variance), color="grey") +
scale_fill_viridis(option="D", na.value="white",
guide  ="legend", name="Variance\nEstimate",
breaks = MAT %>% pull(Variance) %>% unique %>% sort,
labels = scales::number_format(accuracy = 0.01))
ggplot(data=MAT, aes(x=X, y=Y)) + coord_fixed() +
geom_tile(aes( fill=Variance), color="grey") +
scale_fill_viridis(option="D", na.value="white",
guide  ="legend", name="Variance\nEstimate",
breaks = MAT %>% pull(Variance) %>% unique %>% sort,
labels = scales::number_format(accuracy = 0.01)) +
scale_y_continuous(name = "date-density-combination",
trans = "reverse",
expand = c(0,0),
breaks = labs %>% pull(X),
labels = labs %>% pull(date_densf),
sec.axis = sec_axis(~ .,
name = "genotpye",
breaks = labs %>% pull(X),
labels = labs %>% pull(gen)))
labs
MAT
mat5
mat4
setwd("D:/Coding/MMFAIR")
library("rmarkdown")
rmarkdown::clean_site()  # delete old files
rmarkdown::render_site(encoding="UTF-8") # render all files new; UTF-8 for ä, ö, ü, ß
# get r files from rmd files
knitr::purl("heterogeneous_error_variance.Rmd",documentation=0)
